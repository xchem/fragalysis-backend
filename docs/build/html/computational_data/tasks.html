
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Uploading data (Celery tasks and django template) &#8212; Fragalysis-Backend  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/functions.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Serving static files (media)" href="../API/media.html" />
    <link rel="prev" title="Miscellaneous data" href="../API/misc_views.html" />

  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />


  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <div class="section" id="uploading-data-celery-tasks-and-django-template">
<span id="comp-tasks"></span><h1>Uploading data (Celery tasks and django template)<a class="headerlink" href="#uploading-data-celery-tasks-and-django-template" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introducton">
<h2>Introducton<a class="headerlink" href="#introducton" title="Permalink to this headline">¶</a></h2>
<p>Uploading a Target or a Computed Set (see [link]) is a process that takes a long time. Typical requests handled in django
applications usually only take milliseconds. Because this process takes a long time, we have implemented the required
components as Celery tasks, and written views that can handle kicking off the relevant tasks, and retrieve the results
from the tasks by pinging the message queue that brokers the tasks (Redis).</p>
<p>Celery is a task queuing software package, allowing execution of asynchronous workloads. A synchronous operation blocks
a process till the operation completes. An asynchronous operation is non-blocking and only initiates the operation. In
the context of a web-server, this means we can kick off an operation through an endpoint, and query another endpoint to
periodically check if the task has completed, and when it has, retrieve the results.</p>
<p>This is advantageous when using processes that can take a long time, because browsers often have built in settings where
the longest it will wait for the result of a request is around 30 seconds. If the task we want to run takes longer than
that, the user will receive a timeout message.</p>
<p>Instead, we can use a django template that uses a bit of javascript to dynamically ping the endpoint that checks on the
status of a job, and renders a result or message in the same page when it is completed or fails.</p>
<p>A good tutorial about using Celery and Redis with django can be found here:
<a class="reference external" href="https://stackabuse.com/asynchronous-tasks-in-django-with-redis-and-celery/">https://stackabuse.com/asynchronous-tasks-in-django-with-redis-and-celery/</a></p>
</div>
<div class="section" id="template-the-upload-page-for-computed-sets">
<h2>Template - the upload page for computed sets<a class="headerlink" href="#template-the-upload-page-for-computed-sets" title="Permalink to this headline">¶</a></h2>
<p>A django template (<a class="reference external" href="https://docs.djangoproject.com/en/3.1/topics/templates/">https://docs.djangoproject.com/en/3.1/topics/templates/</a>) is an HTML document that can dynamically
load content from django objects, such as models and views. For example, we could query the Target model, and dynamically
create a list of all Target names in a template.</p>
<p>For example, the template for the upload page for computed sets is found at <code class="code docutils literal notranslate"><span class="pre">viewer/templates/viewer/upload-cset.html</span></code>.
A similar page (upload-tset.html) exists for Targets. The main parts of the template are as follows:</p>
<p><strong>1. The upload form</strong> - this part of the template makes use of <code class="code docutils literal notranslate"><span class="pre">viewer.forms.CSetForm</span></code>: a version of a <code class="code docutils literal notranslate"><span class="pre">Model</span></code>
that is used to describe what information can be posted as a request through a form contained in a template.</p>
<dl class="class">
<dt id="viewer.forms.CSetForm">
<em class="property">class </em><code class="sig-prename descclassname">viewer.forms.</code><code class="sig-name descname">CSetForm</code><span class="sig-paren">(</span><em class="sig-param">data=None</em>, <em class="sig-param">files=None</em>, <em class="sig-param">auto_id='id_%s'</em>, <em class="sig-param">prefix=None</em>, <em class="sig-param">initial=None</em>, <em class="sig-param">error_class=&lt;class 'django.forms.utils.ErrorList'&gt;</em>, <em class="sig-param">label_suffix=None</em>, <em class="sig-param">empty_permitted=False</em>, <em class="sig-param">field_order=None</em>, <em class="sig-param">use_required_attribute=None</em>, <em class="sig-param">renderer=None</em><span class="sig-paren">)</span><a class="headerlink" href="#viewer.forms.CSetForm" title="Permalink to this definition">¶</a></dt>
<dd><p>A Django form used for uploading Computed sets at viewer/upload_cset</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>target_name</strong> (<em>CharField</em>) – The name of the target, as written in <cite>viewer.models.Targets</cite> that you want to upload a computed set for</p></li>
<li><p><strong>sdf_file</strong> (<em>FileField</em>) – The sdf file that you want to upload, containing information about the 3D structure of all molecules in the computed set.</p></li>
<li><p><strong>pdb_zip</strong> (<em>FileField</em>) – A zip file of apo pdb files referenced by the molecules in sdf_file (optional)</p></li>
<li><p><strong>submit_choice</strong> (<em>CharField</em>) – Whether to validate (0) or validate and upload (1) - displayed as a radio button</p></li>
<li><p><strong>upload_key</strong> (<em>CharField</em>) – The user-specific upload key generated by <cite>viewer.views.cset_key</cite></p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p>The code that shows this form is:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="p">&gt;</span>
    {% csrf_token %}
    {{ form.as_ul }}
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="p">&gt;</span>Submit<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>This code uses standard html tags to show that we’re using a form, and uses django’s templating language to insert the
form as a list (<code class="code docutils literal notranslate"><span class="pre">{{</span> <span class="pre">form.as_ul}}</span></code>)</p>
<p><strong>2. Dynamic loading of validate task status and results</strong> - this part of the template is included as a Javascript
script, and uses a function to periodically ping the task endpoint, updating what is displayed on the page depending on
the tasks status:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>{% if validate_task_id %}
  <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
  <span class="nx">content</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">taskUrl</span> <span class="o">=</span> <span class="s2">&quot;{% url &#39;validate_task&#39; validate_task_id=validate_task_id %}&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">dots</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">progressTitle</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;progress-title&#39;</span><span class="p">);</span>
  <span class="nx">updateProgressTitle</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">timer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">updateProgressTitle</span><span class="p">();</span>
    <span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">taskUrl</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">taskStatus</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">validate_task_status</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">taskStatus</span> <span class="o">===</span> <span class="s1">&#39;SUCCESS&#39;</span><span class="p">)</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;links&#39;</span><span class="p">);</span>
          <span class="nx">content</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">html</span><span class="p">;</span>

          <span class="nx">clearTimer</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">taskStatus</span> <span class="o">===</span> <span class="s1">&#39;FAILURE&#39;</span><span class="p">)</span> <span class="p">{</span>

            <span class="nx">clearTimer</span><span class="p">(</span><span class="s1">&#39;An error occurred - see traceback below&#39;</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;links&#39;</span><span class="p">);</span>
            <span class="nx">content</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">validate_traceback</span><span class="p">;</span>

        <span class="p">}</span>
      <span class="p">})</span>
  <span class="p">},</span> <span class="mi">800</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">updateProgressTitle</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">dots</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dots</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dots</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">progressTitle</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;validating files&#39;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dots</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">progressTitle</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">clearTimer</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
    <span class="nx">progressTitle</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
  <span class="p">}</span>
 <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
{% endif %}
</pre></div>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">{if</span> <span class="pre">validate_task_id}</span></code> and <code class="code docutils literal notranslate"><span class="pre">{</span> <span class="pre">endif</span> <span class="pre">}</span></code> use djangos templating language to make sure that the code
wrapped in <code class="code docutils literal notranslate"><span class="pre">&lt;script&gt;...&lt;/script&gt;</span></code> is only executed if there is a value for <code class="code docutils literal notranslate"><span class="pre">validate_task_id</span></code>. This value
comes from the Validate task, which is described below.</p>
<p>The different variables (<code class="code docutils literal notranslate"><span class="pre">var:...</span></code>) are used to decide what to render on the page in the different elements
defined in functions (e.g. <code class="code docutils literal notranslate"><span class="pre">document.getElementById('links')</span></code> - which looks for the HTML div named <code class="code docutils literal notranslate"><span class="pre">links</span></code>).</p>
<p>The most important variable for dynamic loading is the <code class="code docutils literal notranslate"><span class="pre">response.data.validate_task_status</span></code> variable - this is the
status of the validate task from the Celery task, returned by the Validate task, which is described below.</p>
<p>The responses returned by the View are described in <a class="reference internal" href="views.html#comp-views"><span class="std std-ref">Computational Data (Views)</span></a></p>
<p><strong>3. Dynamic loading of upload task status and results</strong> - this part of the template is included as a Javascript
script, and uses a function to periodically ping the task endpoint, updating what is displayed on the page depending on
the tasks status:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>{% if upload_task_id %}
    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
        <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
        <span class="nx">content</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">taskUrl</span> <span class="o">=</span> <span class="s2">&quot;{% url &#39;upload_task&#39; upload_task_id=upload_task_id %}&quot;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">dots</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">progressTitle</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;progress-title&#39;</span><span class="p">);</span>
        <span class="nx">updateProgressTitle</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">timer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">updateProgressTitle</span><span class="p">();</span>
          <span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">taskUrl</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">taskStatus</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upload_task_status</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">taskStatus</span> <span class="o">===</span> <span class="s1">&#39;SUCCESS&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">validatedStatus</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">validated</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">validatedStatus</span> <span class="o">===</span> <span class="s1">&#39;Not validated&#39;</span><span class="p">)</span> <span class="p">{</span>

                        <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;links&#39;</span><span class="p">);</span>
                        <span class="nx">content</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">html</span><span class="p">;</span>

                        <span class="nx">clearTimer</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">validatedStatus</span> <span class="o">===</span> <span class="s1">&#39;Validated&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">clearTimer</span><span class="p">(</span><span class="s1">&#39;Your files were uploaded! The download links are:&#39;</span><span class="p">);</span>

                        <span class="kd">var</span> <span class="nx">url_a</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">cset_download_url</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;links&#39;</span><span class="p">);</span>
                        <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">);</span>
                        <span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s2">&quot;    Compound Set    &quot;</span><span class="p">);</span>
                        <span class="nx">a</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">link</span><span class="p">);</span>
                        <span class="nx">a</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;compound set&#39;</span><span class="p">;</span>
                        <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url_a</span><span class="p">;</span>
                        <span class="nx">content</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>

                        <span class="kd">var</span> <span class="nx">br</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">);</span>
                        <span class="nx">content</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">br</span><span class="p">);</span>

                        <span class="kd">var</span> <span class="nx">url_b</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">pset_download_url</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">);</span>
                        <span class="kd">var</span> <span class="nx">link_b</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s2">&quot;    Protein Set    &quot;</span><span class="p">);</span>
                        <span class="nx">b</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">link_b</span><span class="p">);</span>
                        <span class="nx">b</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;protein set&#39;</span><span class="p">;</span>
                        <span class="nx">b</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url_b</span><span class="p">;</span>
                        <span class="nx">content</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>

                    <span class="p">}</span>
                    <span class="kd">var</span> <span class="nx">moleculesProcessed</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">processed</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">moleculesProcessed</span> <span class="o">===</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span> <span class="p">{</span>

                        <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;links&#39;</span><span class="p">);</span>
                        <span class="nx">content</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">html</span><span class="p">;</span>

                        <span class="nx">clearTimer</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

                    <span class="p">}</span>
                <span class="p">}</span>
                  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">taskStatus</span> <span class="o">===</span> <span class="s1">&#39;FAILURE&#39;</span><span class="p">)</span> <span class="p">{</span>

                      <span class="nx">clearTimer</span><span class="p">(</span><span class="s1">&#39;An error occurred - see traceback below&#39;</span><span class="p">);</span>
                      <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;links&#39;</span><span class="p">);</span>
                      <span class="nx">content</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upload_traceback</span><span class="p">;</span>

              <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">},</span> <span class="mi">800</span><span class="p">);</span>

        <span class="kd">function</span> <span class="nx">updateProgressTitle</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">dots</span><span class="o">++</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">dots</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dots</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">progressTitle</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;processing uploaded files&#39;</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dots</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">progressTitle</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="kd">function</span> <span class="nx">clearTimer</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
          <span class="nx">progressTitle</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
        <span class="p">}</span>
   <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
{% endif %}
</pre></div>
</div>
<p>This code works in the same way as the Javascript code for the validate task, but instead uses the Upload task described
in <a class="reference internal" href="views.html#comp-views"><span class="std std-ref">Computational Data (Views)</span></a></p>
</div>
<div class="section" id="celery-task-validating-uploaded-data">
<h2>Celery task - validating uploaded data<a class="headerlink" href="#celery-task-validating-uploaded-data" title="Permalink to this headline">¶</a></h2>
<p>The first task that has to be completed when uploading a computed set is validation of the data. This task checks the
format of the uploaded SDF file provided to <code class="code docutils literal notranslate"><span class="pre">viewer.views.UploadCSetView</span></code> to make sure it is in the correct format
and contains all of the required information (specified here: [link]) to upload save the data to the database through
the <code class="code docutils literal notranslate"><span class="pre">viewer.views.UploadTaskView</span></code> into the relevant models specified in
<a class="reference internal" href="schema.html#comp-models"><span class="std std-ref">Computational Data (Models)</span></a>.</p>
<dl class="class">
<dt id="viewer.tasks.validate_compound_set">
<em class="property">class </em><code class="sig-prename descclassname">viewer.tasks.</code><code class="sig-name descname">validate_compound_set</code><a class="headerlink" href="#viewer.tasks.validate_compound_set" title="Permalink to this definition">¶</a></dt>
<dd><p>Celery task to process validate the uploaded files for a computed set upload. SDF file is mandatory, zip file is
optional</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>sdf_file</strong> (<em>str</em>) – filepath of the uploaded sdf file, which is saved to temporary storage by <cite>viewer.views.UploadCSet</cite></p></li>
<li><p><strong>target</strong> (<em>str</em>) – name of the target (<cite>viewer.models.Target.title</cite>) to add add the computed set to</p></li>
<li><p><strong>zfile</strong> (<em>dict</em>) – dictionary where key is the name of the file minus extension and path, and value is the filename, which is saved
to temporary storage by <cite>viewer.views.UploadCSet</cite></p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p><strong>validate_output</strong> –</p>
<dl class="simple">
<dt>contains the following:</dt><dd><ul class="simple">
<li><p>validate dict (dict): dict containing any errors found during the calidation step</p></li>
<li><p>validated (bool): True if the file(s) were validated, False if not</p></li>
<li><p>filename (str): name of the uploaded sdf file</p></li>
<li><p>target (str): name of the target that the computed set is associated with</p></li>
<li><p>zfile (dict): dictionary where key is the name of the file minus extension and path, and value is the
filename, which is saved to temporary storage by <cite>viewer.views.UploadCSet</cite></p></li>
<li><p>submitter_name (str): name of the author of the computed set</p></li>
<li><p>submitter_method (str): name of the method used to generate the computed set</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>tuple</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="celery-task-processing-and-saving-uploaded-data">
<h2>Celery task - processing and saving uploaded data<a class="headerlink" href="#celery-task-processing-and-saving-uploaded-data" title="Permalink to this headline">¶</a></h2>
<p>The second task that has to be completed when uploading a computed set is the upload itself. This task checks takes the
output of <code class="code docutils literal notranslate"><span class="pre">viewer.tasks.validate</span></code> - the uploaded files must be validated before their data can be saved to the
database.</p>
<dl class="class">
<dt id="viewer.tasks.process_compound_set">
<em class="property">class </em><code class="sig-prename descclassname">viewer.tasks.</code><code class="sig-name descname">process_compound_set</code><a class="headerlink" href="#viewer.tasks.process_compound_set" title="Permalink to this definition">¶</a></dt>
<dd><p>Celery task to process a computed set, that takes the output of the validation task, and uploads molecules to a
new computed set if the uploaded files are valid</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>validate_output</strong> (<em>tuple</em>) – <dl class="simple">
<dt>contains the following:</dt><dd><ul class="simple">
<li><p>validate dict (dict): dict containing any errors found during the validation step</p></li>
<li><p>validated (bool): True if the file(s) were validated, False if not</p></li>
<li><p>filename (str): name of the uploaded sdf file</p></li>
<li><p>target (str): name of the target that the computed set is associated with</p></li>
<li><p>zfile (dict): dictionary where key is the name of the file minus extension and path, and value is the filename, which is saved to temporary storage by <cite>viewer.views.UploadCSet</cite></p></li>
<li><p>submitter_name (str): name of the author of the computed set</p></li>
<li><p>submitter_method (str): name of the method used to generate the computed set</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><strong>compound_set.name</strong> – name of the computed set</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="uploading-target-data-sets">
<h2>Uploading Target data sets<a class="headerlink" href="#uploading-target-data-sets" title="Permalink to this headline">¶</a></h2>
<p>From 2021, a similar process has been developed for Target data sets to replace the existing process
that are created from the source data using the Fragalysis Loader repo.
Target data sets are initially created in the same way as currently using the Fragalysis api repo (
found here: <a class="reference external" href="https://github.com/xchem/fragalysis-api">https://github.com/xchem/fragalysis-api</a> ).</p>
<p>The template for the upload page for target sets is found at <code class="code docutils literal notranslate"><span class="pre">viewer/templates/viewer/upload-tset.html</span></code>. The
main parts of the template are similar to the computed sets.</p>
<p>The view controlling interaction is: <code class="code docutils literal notranslate"><span class="pre">viewer.views.UploadTSetView</span></code>.</p>
<p>The upload form is:</p>
<dl class="class">
<dt id="viewer.forms.TSetForm">
<em class="property">class </em><code class="sig-prename descclassname">viewer.forms.</code><code class="sig-name descname">TSetForm</code><span class="sig-paren">(</span><em class="sig-param">data=None</em>, <em class="sig-param">files=None</em>, <em class="sig-param">auto_id='id_%s'</em>, <em class="sig-param">prefix=None</em>, <em class="sig-param">initial=None</em>, <em class="sig-param">error_class=&lt;class 'django.forms.utils.ErrorList'&gt;</em>, <em class="sig-param">label_suffix=None</em>, <em class="sig-param">empty_permitted=False</em>, <em class="sig-param">field_order=None</em>, <em class="sig-param">use_required_attribute=None</em>, <em class="sig-param">renderer=None</em><span class="sig-paren">)</span><a class="headerlink" href="#viewer.forms.TSetForm" title="Permalink to this definition">¶</a></dt>
<dd><p>A Django form used for uploading Target sets at viewer/upload_tset</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>target_name</strong> (<em>CharField</em>) – The name of the target, as written in <cite>viewer.models.Targets</cite> that you want to upload Target set for</p></li>
<li><p><strong>target_zip</strong> (<em>FileField</em>) – A zip file containing a target dataset in a specific format (folders / data)</p></li>
<li><p><strong>submit_choice</strong> (<em>CharField</em>) – Whether to validate (0) or validate and upload (1) - displayed as a radio button</p></li>
<li><p><strong>proposal_ref</strong> (<em>CharField</em>) – Proposal the target should be attached to/validated with.</p></li>
<li><p><strong>contact_email</strong> (<em>EmailField</em>) – An email address to receive upload notifications.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p>Note that the user must be <strong>logged on to Fragalysis</strong> to be able to use the form. When the user is logged on, the
email field is filled with the contents of the user.email field. This is used to send a notification to the user
on completion of an validation/upload task (see below).</p>
<p>Dynamic loading of validate task status and results otherwise works in a similar way to the computational sets.</p>
</div>
<div class="section" id="celery-task-validating-target-data">
<h2>Celery task - validating Target data<a class="headerlink" href="#celery-task-validating-target-data" title="Permalink to this headline">¶</a></h2>
<p>The first task that has to be completed when uploading a target set is validation of the data. This task checks the
format of the folder structure provided to <code class="code docutils literal notranslate"><span class="pre">viewer.views.UploadTSetView</span></code> to make sure it is in the correct format.</p>
<dl class="class">
<dt id="viewer.tasks.validate_target_set">
<em class="property">class </em><code class="sig-prename descclassname">viewer.tasks.</code><code class="sig-name descname">validate_target_set</code><a class="headerlink" href="#viewer.tasks.validate_target_set" title="Permalink to this definition">¶</a></dt>
<dd><p>Celery task to process validate the uploaded files/format for a target set upload. Zip file is mandatory</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>target_zip</strong> (<em>str</em>) – filepath of the uploaded target file, which is saved to temporary storage by <cite>viewer.views.UploadTSet</cite></p></li>
<li><p><strong>target</strong> (<em>str</em>) – name of the target (<cite>viewer.models.Target.title</cite>) to add add the target set to</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p><strong>validate_output</strong> –</p>
<dl class="simple">
<dt>contains the following:</dt><dd><ul class="simple">
<li><p>validate dict (dict): dict containing any errors found during the validation step</p></li>
<li><p>validated (bool): True if the file(s) were validated, False if not</p></li>
<li><p>filename (str): name of the uploaded target file</p></li>
<li><p>target (str): name of the target</p></li>
<li><p>submitter_name (str): name of the user who submitted the upload</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>tuple</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="celery-task-processing-target-data">
<h2>Celery task - processing Target data<a class="headerlink" href="#celery-task-processing-target-data" title="Permalink to this headline">¶</a></h2>
<p>The second task that has to be completed when uploading a computed set is the upload itself. This task checks takes the
output of <code class="code docutils literal notranslate"><span class="pre">viewer.tasks.validate_target_set</span></code> - the uploaded files must be validated before their data can be
saved to the database through the <code class="code docutils literal notranslate"><span class="pre">viewer.views.UploadTaskView</span></code> into the relevant models specified in
<a class="reference internal" href="../crystallographic_data/schema.html#crys-models"><span class="std std-ref">Crystallographic data (Models)</span></a>.</p>
<dl class="class">
<dt id="viewer.tasks.process_target_set">
<em class="property">class </em><code class="sig-prename descclassname">viewer.tasks.</code><code class="sig-name descname">process_target_set</code><a class="headerlink" href="#viewer.tasks.process_target_set" title="Permalink to this definition">¶</a></dt>
<dd><p>Celery task to process a target set, that takes the output of the validation task, and uploads molecules to a
new target set if the uploaded files are valid</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>validate_output</strong> (<em>tuple</em>) – <dl class="simple">
<dt>contains the following:</dt><dd><ul class="simple">
<li><p>validate dict (dict): dict containing any errors found during the validation step</p></li>
<li><p>validated (bool): True if the file(s) were validated, False if not</p></li>
<li><p>filename (str): name of the uploaded target file (zip file)</p></li>
<li><p>target (str): name of the target</p></li>
<li><p>submitter_name (str): name of the author of the computed set</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>name of the processed target set</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>target str</p>
</dd>
</dl>
</dd></dl>

</div>
</div>


          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Fragalysis-Backend</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_setup/stack_setup.html">Local developer environment setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_setup/production.html">Running in Production (+CI/CD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/api_intro.html">RESTful API (Models, Serializers and Views)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crystallographic_data/schema.html">Crystallographic data (Models)</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema.html">Computational data (Models)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/schema.html">Projects data (Models)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crystallographic_data/views.html">Crystallographic data (Views)</a></li>
<li class="toctree-l1"><a class="reference internal" href="views.html">Computational data (Views)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/views.html">Project data (Views)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/misc_views.html">Miscellaneous data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/misc_views.html#tags">Tags</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Uploading data (Celery tasks and django template)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introducton">Introducton</a></li>
<li class="toctree-l2"><a class="reference internal" href="#template-the-upload-page-for-computed-sets">Template - the upload page for computed sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#celery-task-validating-uploaded-data">Celery task - validating uploaded data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#celery-task-processing-and-saving-uploaded-data">Celery task - processing and saving uploaded data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#uploading-target-data-sets">Uploading Target data sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#celery-task-validating-target-data">Celery task - validating Target data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#celery-task-processing-target-data">Celery task - processing Target data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../API/media.html">Serving static files (media)</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../API/misc_views.html" title="previous chapter">Miscellaneous data</a></li>
      <li>Next: <a href="../API/media.html" title="next chapter">Serving static files (media)</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Rachael Skyner.

      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>

      |
      <a href="../_sources/computational_data/tasks.rst.txt"
          rel="nofollow">Page source</a>
    </div>




  </body>
</html>
